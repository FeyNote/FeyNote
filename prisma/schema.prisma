// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String          @id @default(uuid()) @db.Uuid
  createdAt       DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime        @updatedAt @db.Timestamptz(6)
  email           String          @unique
  passwordHash    String?
  passwordSalt    String?
  passwordVersion Int?
  username        String?
  preferences     Json?
  yManifestBin    Bytes           @db.ByteA
  sessions        Session[]
  files           File[]
  artifacts       Artifact[]
  artifactShares  ArtifactShare[]
}

model Session {
  id              String   @id @default(uuid()) @db.Uuid
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String   @db.Uuid
  token           String   @unique @db.VarChar(255)
  expiresAt       DateTime @db.Timestamptz(6)
  extendableUntil DateTime @db.Timestamptz(6)
  createdAt       DateTime @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @db.Timestamptz(6)
}

model Artifact {
  id                         String              @id @default(uuid()) @db.Uuid
  user                       User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                     String              @db.Uuid
  yBin                       Bytes               @db.ByteA
  syncVersion                Int                 @default(1)
  createdAt                  DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt                  DateTime            @updatedAt @db.Timestamptz(6)
  artifactShares             ArtifactShare[]
  artifactReferences         ArtifactReference[] @relation("artifactReferenceSourceArtifact")
  incomingArtifactReferences ArtifactReference[] @relation("artifactReferenceTargetArtifact")
}

model ArtifactReference {
  id String @id @default(uuid()) @db.Uuid

  artifactId      String   @db.Uuid
  artifact        Artifact @relation("artifactReferenceSourceArtifact", fields: [artifactId], references: [id], onDelete: Cascade)
  artifactBlockId String   @db.Uuid

  // Used for actual reference to artifact, so we can join
  referenceTargetArtifactId String?   @db.Uuid
  targetArtifact            Artifact? @relation("artifactReferenceTargetArtifact", fields: [referenceTargetArtifactId], references: [id], onDelete: SetNull)

  // Target artifact may not actually exist
  targetArtifactId      String  @db.Uuid
  targetArtifactBlockId String? @db.Uuid

  referenceText String

  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)
}

model ArtifactShare {
  id          String   @id @default(uuid()) @db.Uuid
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String   @db.Uuid
  artifact    Artifact @relation(fields: [artifactId], references: [id], onDelete: Cascade)
  artifactId  String   @db.Uuid
  accessLevel String
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)
}

model File {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @db.Uuid
  user       User     @relation(fields: [userId], references: [id])
  mimetype   String
  filename   String
  storageKey String
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @updatedAt @db.Timestamptz(6)
}
