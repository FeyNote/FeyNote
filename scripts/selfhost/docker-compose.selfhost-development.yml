# FeyNote for personal, selfhosted use
# This file was last updated 2025-12-15
# When updating your config, please apply an UPGRADING.md instructions since your selfhost configuration's release date

services:
  # Nginx reverse proxy with frontend and docs, serves as entrypoint and router for app and services
  proxy:
    build:
      context: ../..
      dockerfile: ./scripts/selfhost/Dockerfile.selfhost.proxy
    ports:
      - '${FEYNOTE_SELFHOST_HTTP_PORT:-7271}:80'
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - feynote

  # Main Feynote application - all backend services in one container
  # Includes: Backend API, Hocuspocus, Websocket, Queue Worker, and WWW (Astro)
  app:
    build:
      context: ../..
      dockerfile: ./scripts/selfhost/Dockerfile.selfhost.app
    environment:
      # Please leave all of these as-is
      HOCUSPOCUS_REDIS_HOST: redis
      HOCUSPOCUS_REDIS_PORT: 6379
      WEBSOCKET_REDIS_HOST: redis
      WEBSOCKET_REDIS_PORT: 6379
      WORKER_REDIS_HOST: redis
      WORKER_REDIS_PORT: 6379
      TYPESENSE_NODES: '[{"host": "typesense", "port": 8108, "protocol": "http"}]'

      # Please change this via your .env file rather than directly here!
      DATABASE_URL: postgresql://${POSTGRES_USER:-feynote}:${POSTGRES_PASSWORD:-feynote}@postgres:5432/${POSTGRES_DB:-feynote}
      # Please change this via your .env file rather than directly here!
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY:-feynote-selfhost}
      # Please change this via your .env file rather than directly here!
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
    volumes:
      - app_data:/app/data
    healthcheck:
      test:
        ['CMD', 'wget', '--spider', '-q', 'http://localhost:3000/trpc/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      typesense:
        condition: service_started
    restart: unless-stopped
    networks:
      - feynote

  # PostgreSQL Database for content storage
  postgres:
    image: postgres:16-alpine
    environment:
      # Please change these via your .env file rather than directly here!
      POSTGRES_USER: ${POSTGRES_USER:-feynote}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-feynote}
      POSTGRES_DB: ${POSTGRES_DB:-feynote}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-feynote}']
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - feynote

  # Redis for real-time features (such as collaboration) and queued jobs such as importing content
  redis:
    image: redis:7-alpine
    command: redis-server --maxmemory 512mb --maxmemory-policy noeviction
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - feynote

  # Typesense for advanced fulltext search
  typesense:
    image: typesense/typesense:27.1
    environment:
      TYPESENSE_DATA_DIR: /data
      # Please change this via your .env file rather than directly here!
      TYPESENSE_API_KEY: ${TYPESENSE_API_KEY:-feynote-selfhost}
    volumes:
      - typesense_data:/data
    restart: unless-stopped
    networks:
      - feynote

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  typesense_data:
    driver: local
  app_data:
    driver: local

networks:
  feynote:
    driver: bridge
